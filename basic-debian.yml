- name: Basic Debian Installation
  hosts: fuckup.luxeria.ch
  sudo: True

  tasks:
    - name: Install basic software
      apt: name={{ item }}
      with_items:
        - ack-grep
        - renameutils
        - git
        - convmv
        - curl
        - haveged
        - htop
        - rsync
        - sysstat
        - tmux
        - unzip
        - vim

    - name: Add users
      user: name=emanuel shell=/bin/bash state=present

    - name: Install ufw firewall
      apt: name=ufw state=present
    - name: Set firewall default policy
      ufw: state=enabled
    - name: Allow SSH
      ufw: rule=allow port=22 proto=tcp
    - name: Configure Firewall
      ufw: rule=allow port={{item.port}} proto={{item.proto}}
      with_items: "{{ ufw_allow_in }}"

    - name: motd file
      template: src=templates/motd.j2 dest=/etc/motd owner=root group=root mode=0644

    - name: systemd-timesyncd
      service: name=systemd-timesyncd state=started enabled=yes
    - name: systemd-timesyncd configuration file
      template: src=templates/timesyncd.conf.j2 dest=/etc/systemd/timesyncd.conf owner=root group=root mode=0644
      notify: restart systemd-timesyncd

    - name: haveged
      service: name=haveged state=started enabled=yes

    - name: sshd configuration file
      template: src=templates/sshd_config.j2 dest=/etc/ssh/sshd_config
        owner=root group=root mode=0644
        validate='/usr/sbin/sshd -T -f %s'
      notify: restart sshd
    - name: Install sshguard
      apt: name=sshguard state=present
    - name: Start and enable sshguard
      service: name=sshguard state=started enabled=yes

    - name: Install Monitoring tools
      apt: name={{ item }}
      with_items:
        - logwatch
        - logcheck
    - name: Install Munin-Node # irgendwo noch munin als master
      apt: name={{ item }}
      with_items:
        - munin-node
        - smartmontools
        - ipmitool
    - name: Allow Munin
      ufw: rule=allow port=4949 proto=tcp
    - name: Enable some plugins
      file: src=/usr/share/munin/plugins/{{ item.src }} dest=/etc/munin/plugins/{{ item.dest }} state=link
      with_items:
        - { src: 'apt', dest: 'apt' }
        - { src: 'apt_all', dest: 'apt_all' }
        - { src: 'iostat', dest: 'iostat' }
        - { src: 'iostat_ios', dest: 'iostat_ios' }
        - { src: 'ping_', dest: 'ping_speedtest.net' }
        - { src: 'port_', dest: 'port_ssh' }
        - { src: 'ps_', dest: 'ps_sshd' }
        - { src: 'threads', dest: 'threads' }
    - name: Monitor connection count of allowed firewall ports
      file: src=/usr/share/munin/plugins/port_ dest=/etc/munin/plugins/port_{{ item.port }} state=link
      with_items: "{{ ufw_allow_in }}"

  handlers:
    - name: restart systemd-timesyncd
      service: name=systemd-timesyncd state=restarted
    - name: restart sshd
      service: name=sshd state=restarted
