- name: Basic Debian Installation
  sudo: True
  hosts: debian
  tasks:
    - name: Install basic software
      apt: name={{ item }}
      with_items:
        - rsync
        - sysstat
        - htop
        - tmux
        - vim
        - ufw
        - mosh

    - name: Add users
      user: name={{item.name}} shell=/bin/bash groups={{item.groups}} state=present
      with_items: "{{ users }}"

    - name: Install public key only if available
      authorized_key: user={{item.name}} key="{{ lookup('file', 'files/ssh_keys/{{item.ssh_key}}') }}"
      with_items: "{{ users }}"

    - name: sudo configuration
      lineinfile: dest=/etc/sudoers state=present regexp='^%sudo' line='%sudo ALL=(ALL:ALL) NOPASSWD:ALL' validate='visudo -cf %s'

    - name: Install ufw firewall
      apt: name=ufw state=present
    - name: Set firewall default policy
      ufw: state=enabled
    - name: Allow SSH
      ufw: rule=allow port=22 proto=tcp
    - name: Allow mosh
      ufw: rule=allow port=60000:61000 proto=udp
    - name: Configure Firewall
      ufw: rule=allow port={{item.port}} proto={{item.proto}}
      with_items: "{{ ufw_allow_in }}"

    - name: hosts file
      template: src=templates/hosts.j2 dest=/etc/hosts owner=root group=root mode=0644

    - name: motd file
      template: src=templates/motd.j2 dest=/etc/motd owner=root group=root mode=0644

    - name: systemd-timesyncd
      service: name=systemd-timesyncd state=started enabled=yes
    - name: systemd-timesyncd configuration file
      template: src=templates/timesyncd.conf.j2 dest=/etc/systemd/timesyncd.conf owner=root group=root mode=0644
      notify: restart systemd-timesyncd

    - name: sshd configuration file
      template: src=templates/sshd_config.j2 dest=/etc/ssh/sshd_config
        owner=root group=root mode=0644
        validate='/usr/sbin/sshd -T -f %s'
      notify: restart sshd
    - name: Install sshguard
      apt: name=sshguard state=present
    - name: Start and enable sshguard
      service: name=sshguard state=started enabled=yes

    - name: Install Monitoring tools
      apt: name={{ item }}
      with_items:
        - logwatch
        - logcheck
    - name: Install Munin-Node # irgendwo noch munin als master
      apt: name={{ item }}
      with_items:
        - munin-node
        - smartmontools
        - ipmitool
    - name: Allow Munin
      ufw: rule=allow port=4949 proto=tcp
    - name: Enable some plugins
      file: src=/usr/share/munin/plugins/{{ item.src }} dest=/etc/munin/plugins/{{ item.dest }} state=link
      with_items:
        - { src: 'apt', dest: 'apt' }
        - { src: 'apt_all', dest: 'apt_all' }
        - { src: 'iostat', dest: 'iostat' }
        - { src: 'iostat_ios', dest: 'iostat_ios' }
        - { src: 'ping_', dest: 'ping_speedtest.net' }
        - { src: 'port_', dest: 'port_ssh' }
        - { src: 'ps_', dest: 'ps_sshd' }
        - { src: 'threads', dest: 'threads' }
      notify: restart munin-node
    - name: Monitor connection count of allowed firewall ports
      file: src=/usr/share/munin/plugins/port_ dest=/etc/munin/plugins/port_{{ item.port }} state=link
      with_items: "{{ ufw_allow_in }}"
      notify: restart munin-node

  handlers:
    - name: restart systemd-timesyncd
      service: name=systemd-timesyncd state=restarted
    - name: restart sshd
      service: name=sshd state=restarted
    - name: restart munin-node
      service: name=munin-node state=restarted
